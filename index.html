<script>
  // Tabelas de bônus de altura/peso
  const bonusAltura = {
    '1.50-1.55': { drible: 3, explosao: 2, reflexos: 2, cabeceio: -3, intimidacao: -2, defesa: -2 },
    '1.56-1.60': { drible: 2, explosao: 2, reflexos: 2, cabeceio: -3, intimidacao: -2, defesa: -1 },
    '1.61-1.65': { drible: 2, explosao: 1, reflexos: 2, cabeceio: -2, intimidacao: -1, defesa: -1 },
    '1.66-1.70': { drible: 2, explosao: 1, reflexos: 1, cabeceio: -2, defesa: -1 },
    '1.71-1.75': { drible: 1, reflexos: 1, cabeceio: -1 },
    '1.76-1.80': {},
    '1.81-1.85': { cabeceio: 1, intimidacao: 1, defesa: 1, explosao: -1 },
    '1.86-1.90': { cabeceio: 2, intimidacao: 1, defesa: 2, explosao: -2 },
    '1.91-1.95': { cabeceio: 2, intimidacao: 2, defesa: 2, explosao: -2, drible: -1 },
    '1.96-2.00': { cabeceio: 3, intimidacao: 2, defesa: 3, explosao: -3, drible: -2, reflexos: -1 },
    '2.01-2.05': { cabeceio: 3, intimidacao: 3, defesa: 4, explosao: -4, drible: -2, reflexos: -2 }
  };

  const bonusPeso = {
    '50-55': { explosao: 3, acrobacia: 2, furtividade: 2, reflexos: 1, corpo: -3, intimidacao: -2, defesa: -2 },
    '56-60': { explosao: 2, acrobacia: 2, furtividade: 1, reflexos: 1, corpo: -3, intimidacao: -2, defesa: -1 },
    '61-65': { explosao: 2, acrobacia: 1, furtividade: 1, reflexos: 1, corpo: -2, intimidacao: -1 },
    '66-70': { explosao: 2, acrobacia: 1, reflexos: 1, corpo: -2 },
    '71-75': {},
    '76-80': { corpo: 1, chute: 1, defesa: 1, explosao: -1 },
    '81-85': { corpo: 2, chute: 1, defesa: 1, explosao: -2, reflexos: -1 },
    '86-90': { corpo: 2, chute: 2, defesa: 2, explosao: -2, reflexos: -1 },
    '91-95': { corpo: 3, chute: 2, defesa: 3, explosao: -3, reflexos: -2 },
    '96-100': { corpo: 3, chute: 3, defesa: 4, explosao: -4, reflexos: -2, drible: -1 }
  };

  // Função para identificar intervalo
  function getBonus(value, table) {
    const numValue = Number(value);
    if (isNaN(numValue)) return {};
    
    for (const range in table) {
      const [minStr, maxStr] = range.split('-');
      const min = Number(minStr);
      const max = Number(maxStr);
      
      if (numValue >= min && numValue <= max) {
        return table[range] || {};
      }
    }
    return {};
  }

  // Calcular todas as perícias - FUNÇÃO CORRIGIDA
  function calcularPericias() {
    const altura = parseFloat(document.getElementById('altura').value) || 1.75;
    const peso = parseInt(document.getElementById('peso').value) || 70;
    const perna = document.getElementById('perna').value;
    const posicao = document.getElementById('posicao').value;
    const folegoAtual = parseInt(document.getElementById('folego-atual').value) || 10;
    const folegoTotal = parseInt(document.getElementById('folego-total').value) || 10;

    const bonusA = getBonus(altura, bonusAltura);
    const bonusP = getBonus(peso, bonusPeso);

    // Ajustar bônus de defesa para não goleiros
    function ajustarDefesa(bonus) {
      if (posicao !== 'goleiro') {
        if (bonus.defesa && (altura >= 1.86 || peso >= 86)) {
          bonus.defesa = Math.floor(bonus.defesa / 2);
        }
      }
      return bonus;
    }

    const bonusAjustadoA = ajustarDefesa({...bonusA});
    const bonusAjustadoP = ajustarDefesa({...bonusP});

    // Atualizar barra de fôlego - CORRIGIDO
    const porcentagemFolego = Math.min(100, (folegoAtual / folegoTotal) * 100);
    document.getElementById('barra-folego').style.width = `${porcentagemFolego}%`;
    
    // Verificar se aplica penalidade de fôlego
    let staminaPenalty = 1;
    let staminaClass = '';
    
    if (folegoAtual <= 10 && folegoAtual > 0) {
      staminaPenalty = 0.5;
      staminaClass = 'low-stamina';
    } else if (folegoAtual === 0) {
      staminaPenalty = 0;
      staminaClass = 'no-stamina';
    }

    document.querySelectorAll('.pericia-item').forEach(item => {
      item.classList.remove('low-stamina', 'no-stamina');
      if (staminaClass) {
        item.classList.add(staminaClass);
      }
      
      const periciaId = item.querySelector('.pericia-manual').dataset.pericia;
      const card = item.closest('.card-atributo');
      const atributoId = card.querySelector('.atributo-input').id;
      const valorAtributo = parseInt(document.getElementById(atributoId).value) || 0;

      // Cálculo base (metade do atributo arredondado para baixo)
      let valor = Math.floor(valorAtributo / 2);

      // Aplicar bônus de altura/peso
      if (bonusAjustadoA[periciaId]) valor += bonusAjustadoA[periciaId];
      if (bonusAjustadoP[periciaId]) valor += bonusAjustadoP[periciaId];

      // Aplicar ambidestria - CORRIGIDO
      if (perna === 'ambidestro') {
        if (['passe','drible','dominio','roubo'].includes(periciaId)) {
          valor += 5;
        }
        if ((periciaId === 'pontaria' && escolhaAmbidestro === 'pontaria') || 
            (periciaId === 'chute' && escolhaAmbidestro === 'chute')) {
          valor += 5;
        }
      }

      // Aplicar pontos manuais
      const pontosManuais = parseInt(item.querySelector('.pericia-manual').value) || 0;
      let valorTotal = valor + pontosManuais;

      // Aplicar penalidade de fôlego
      if (staminaPenalty !== 1) {
        valorTotal = Math.floor(valorTotal * staminaPenalty);
      }

      item.querySelector('.pericia-total').textContent = valorTotal;
    });

    // Atualizar deslocamento
    const velocidade = parseInt(document.getElementById('velocidade').value) || 0;
    let deslocamentoBase = 10 + Math.floor(velocidade / 2);
    let deslocamentoFinal = staminaPenalty === 0 ? 0 : Math.floor(deslocamentoBase * staminaPenalty);
    document.getElementById('deslocamento').value = deslocamentoFinal;
  }

  // Mostrar/ocultar campo SG - CORRIGIDO
  function atualizarCamposPosicao() {
    const posicao = document.getElementById('posicao').value;
    const sgContainer = document.getElementById('sg-container');
    
    if (['goleiro', 'zagueiro', 'lateral_direito', 'lateral_esquerdo'].includes(posicao)) {
      sgContainer.style.display = 'block';
    } else {
      sgContainer.style.display = 'none';
    }
  }

  // Inicialização
  document.addEventListener('DOMContentLoaded', function() {
    // ... (código existente)
    
    // Adicionar eventos aos campos relevantes
    const campos = ['altura', 'peso', 'perna', 'folego-atual', 'folego-total', 'posicao'];
    campos.forEach(id => {
      document.getElementById(id).addEventListener('change', calcularPericias);
    });
    
    // Event listeners para atributos e perícias
    const atributos = ['potencia', 'tecnica', 'velocidade', 'agilidade', 'ego'];
    atributos.forEach(attr => {
      document.getElementById(attr).addEventListener('input', calcularPericias);
    });
    
    document.querySelectorAll('.pericia-manual').forEach(input => {
      input.addEventListener('input', calcularPericias);
    });
    
    // Chamar as funções inicialmente
    atualizarCamposPosicao();
    calcularPericias();
  });
</script>
